<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>선우택배 · 통관 진행 조회</title>
  <style>
    :root{
      --bg:#070B14;
      --panel:#0E1627;
      --panel2:#0B1220;
      --line:rgba(255,255,255,.10);
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.70);
      --accent:#5C7CFA;
      --good:#37D67A;
      --bad:#FF4D6D;
      --warn:#FFCC00;
      --shadow:0 20px 70px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 18% 8%, rgba(92,124,250,.20), transparent 60%),
        radial-gradient(900px 500px at 85% 18%, rgba(55,214,122,.14), transparent 60%),
        radial-gradient(900px 500px at 40% 90%, rgba(255,77,109,.10), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1050px;margin:0 auto;padding:22px}
    .top{
      display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .brand .sub{margin-top:6px;color:var(--muted);font-size:12.5px;line-height:1.45}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 60%), var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .ph{padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .ph b{font-size:14px}
    .ph .hint{color:var(--muted);font-size:12px}
    .pb{padding:16px}
    .grid{
      display:grid;grid-template-columns: 1fr auto;
      gap:10px;align-items:end;
    }
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input,button{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(234,240,255,.45)}
    button{
      width:auto;
      padding:12px 16px;
      border:none;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(135deg, rgba(92,124,250,.95), rgba(55,214,122,.70));
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .err{
      border-color: rgba(255,77,109,.35);
      background: rgba(255,77,109,.12);
      color:#ffdbe2;
    }
    .ok{
      border-color: rgba(55,214,122,.35);
      background: rgba(55,214,122,.10);
      color:#dbffe9;
    }
    .cards{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:14px;
    }
    @media(max-width:880px){.cards{grid-template-columns:1fr 1fr}}
    @media(max-width:520px){.cards{grid-template-columns:1fr}}
    .card{
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .k{font-size:11px;color:var(--muted);margin-bottom:6px}
    .v{font-size:14px;font-weight:900;word-break:break-word}
    .v.small{font-weight:800;font-size:13px;color:rgba(234,240,255,.88)}
    .table{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:rgba(255,255,255,.02);
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,.07);vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:900;background:rgba(255,255,255,.03)}
    td{font-size:13px;color:rgba(234,240,255,.92)}
    tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
    .raw{
      margin-top:14px;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:rgba(255,255,255,.02)
    }
    .rawh{
      padding:10px 12px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px
    }
    .rawh b{font-size:13px}
    .rawh button{
      background:rgba(255,255,255,.10);border:1px solid var(--line);
      padding:8px 10px;border-radius:12px;font-weight:900
    }
    pre{margin:0;padding:12px;white-space:pre-wrap;word-break:break-word;color:rgba(234,240,255,.9)}
    .foot{margin-top:10px;color:rgba(234,240,255,.55);font-size:11.5px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>선우택배 · 통관 진행 조회</h1>
        <div class="sub">
          HBL(운송장번호)만 입력하면 됨. 연도(blYy)는 시스템이 <b>자동으로</b> 찾아서 조회함.<br/>
          <span class="muted">v5.7-ui (endpoint fix)</span>
        </div>
      </div>
      <div class="row">
        <div class="pill"><span class="dot" id="dot"></span><span id="state">대기</span></div>
        <div class="pill"><span class="mono">/.netlify/functions/unipass</span></div>
      </div>
    </div>

    <div class="panel">
      <div class="ph">
        <b>조회</b>
        <div class="hint">※ 지금 404/400 뜨던 건 “/api/unipass 경로” + “파라미터 이름(type/no)”이 안 맞아서였음. 이번 버전은 고정.</div>
      </div>
      <div class="pb">
        <div class="grid">
          <div>
            <label>HBL(운송장번호)</label>
            <input id="hbl" placeholder="예) 300046199451" autocomplete="off" inputmode="numeric" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btn">조회</button>
          </div>
        </div>
        <div class="msg" id="msg" style="display:none"></div>

        <div id="result"></div>
      </div>
    </div>

    <div class="foot">
      팁: 새 배포가 적용 안 되면 <b>Ctrl+F5</b> (강력 새로고침). 그래도 안 되면 브라우저 캐시 삭제.
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const setState = (kind, text) => {
    $("state").textContent = text;
    const d = $("dot");
    d.className = "dot" + (kind === "ok" ? " ok" : kind === "bad" ? " bad" : "");
  };

  const showMsg = (text, kind="") => {
    const el = $("msg");
    el.style.display = "block";
    el.className = "msg" + (kind === "err" ? " err" : kind === "ok" ? " ok" : "");
    el.innerHTML = text;
  };

  const hideMsg = () => {
    const el = $("msg");
    el.style.display = "none";
    el.textContent = "";
    el.className = "msg";
  };

  const esc = (s) => (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

  const fmtDttm = (s) => {
    s = (s||"").trim();
    // YYYYMMDDHHMMSS
    if (/^\d{14}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}:${s.slice(12,14)}`;
    // YYYYMMDDHHMM
    if (/^\d{12}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}:00`;
    // YYYYMMDD
    if (/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
    return s;
  };

  const firstText = (node, tag) => {
    const el = node.getElementsByTagName(tag)[0];
    return el ? (el.textContent || "").trim() : "";
  };

  const anyText = (node, tags) => {
    for (const t of tags) {
      const v = firstText(node, t);
      if (v) return v;
    }
    return "";
  };

  const looksLikeCode = (v) => {
    v = (v||"").trim();
    if (!v) return true;
    if (/^\d{8,}$/.test(v)) return true;                // date/time
    if (/^[A-Z0-9]{8,}$/.test(v)) return true;           // codes like AE..., 25MUZ...
    if (/^[0-9A-Z-_/]{8,}$/.test(v) && !/[가-힣]/.test(v)) return true;
    return false;
  };

  async function fetchXml(hbl, blYy){
    // ✅ IMPORTANT: correct params for our Netlify function:
    // type=hbl, no=<HBL>, blYy=<year>
    const qs = new URLSearchParams({ type: "hbl", no: hbl, blYy: String(blYy) });
    const url = `/.netlify/functions/unipass?${qs.toString()}`;
    const r = await fetch(url);
    const t = await r.text();
    if (!r.ok) {
      const msg = esc(t || `HTTP ${r.status}`);
      throw new Error(`API 오류 (year=${blYy}) → HTTP ${r.status}<br/><span class="mono">${esc(url)}</span><br/>${msg}`);
    }
    return { xmlText: t, url };
  }

  function parse(xmlDoc, hbl){
    const root = xmlDoc;

    const tCnt = anyText(root, ["tCnt"]);
    const ntce = anyText(root, ["ntceInfo"]);

    const vo = root.getElementsByTagName("cargCsclPrgsInfoQryVo")[0] || root;

    const summary = {
      hbl,
      tCnt,
      ntce,
      status: anyText(vo, ["csclPrgsStts","prcsStts","prgsStts"]),
      prcsDttm: fmtDttm(anyText(vo, ["prcsDttm","rlbrDttm","prcsDt"])),
      prnm: anyText(vo, ["prnm","gdsNm","prdtNm"]),
      etprDt: fmtDttm(anyText(vo, ["etprDt","etprYmd","etprDt8"])),
      // ✅ tags you told:
      express: anyText(root, ["frwrEntsConm"]),        // 특송업체
      carrier: anyText(root, ["shcoFlco","shcoFlcoNm"]), // 선사/항공사
      customsNm: anyText(root, ["cstmNm","csclCstmNm","dclrCstmNm"]),
      customsCd: anyText(root, ["cstmCd","csclCstmCd"]),
      // (optional) storage location
      shedNm: anyText(vo, ["shedNm"]),
      // count
      dtlCount: 0,
      steps: []
    };

    const dtls = Array.from(root.getElementsByTagName("cargCsclPrgsInfoDtlQryVo"));
    summary.dtlCount = dtls.length;

    summary.steps = dtls.map(n => {
      let stage = anyText(n, ["cargTrcnRelaBsopTpcdNm","prcsStts","csclPrgsStts"]);
      // fallback: sometimes stage can appear in guidance/content, but NEVER use codes/time
      if (!stage || looksLikeCode(stage)) stage = "";
      const time = fmtDttm(anyText(n, ["prcsDttm","rlbrDttm","prcsDt"]));
      const place = anyText(n, ["shedNm","shedSgn","dsprNm"]);
      const remark = anyText(n, ["rlbrCn","bfhnGdncCn","ntceInfo"]);
      return { stage, time, place, remark };
    }).sort((a,b)=> (b.time||"").localeCompare(a.time||""));

    // If customs name missing but code exists, show code in name slot
    if (!summary.customsNm && summary.customsCd) summary.customsNm = `세관코드 ${summary.customsCd}`;

    return summary;
  }

  function render(summary, xmlText, usedYear, usedUrl){
    const cards = [
      ["특송업체", summary.express || "-"],
      ["선사/항공사", summary.carrier || "-"],
      ["세관", summary.customsNm || "-"],
      ["상태", summary.status || "-"],
      ["처리", summary.prcsDttm || "-"],
      ["이력 건수", String(summary.dtlCount || 0)],
      ["품명", summary.prnm || "-"],
      ["입항일", summary.etprDt || "-"],
      ["HBL", summary.hbl || "-"],
    ];

    const cardsHtml = `
      <div class="cards">
        ${cards.map(([k,v]) => `
          <div class="card">
            <div class="k">${esc(k)}</div>
            <div class="v">${esc(v)}</div>
          </div>
        `).join("")}
      </div>
    `;

    const rows = summary.steps.map(s => `
      <tr>
        <td>${esc(s.stage || "-")}</td>
        <td class="mono">${esc(s.time || "-")}</td>
        <td>${esc(s.place || "-")}</td>
        <td>${esc(s.remark || "-")}</td>
      </tr>
    `).join("");

    const tableHtml = `
      <div class="msg ok">
        조회 연도: <b>${esc(String(usedYear))}</b> ·
        호출: <span class="mono">${esc(usedUrl)}</span>
      </div>
      ${cardsHtml}
      <div class="table" style="margin-top:14px">
        <table>
          <thead>
            <tr>
              <th style="width:26%">처리단계</th>
              <th style="width:18%">처리일시</th>
              <th style="width:32%">장치장/장치위치</th>
              <th>반출입(처리)내용</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="4" class="muted">이력 없음</td></tr>`}
          </tbody>
        </table>
      </div>
      <div class="raw">
        <div class="rawh">
          <b>원문(XML)</b>
          <button id="toggleRaw" type="button">접기/펼치기</button>
        </div>
        <pre id="rawPre">${esc(xmlText)}</pre>
      </div>
    `;

    $("result").innerHTML = tableHtml;

    const btn = $("toggleRaw");
    const pre = $("rawPre");
    if (btn && pre) {
      let hidden = false;
      btn.onclick = () => {
        hidden = !hidden;
        pre.style.display = hidden ? "none" : "block";
      };
    }
  }

  async function query(){
    const hbl = ($("hbl").value || "").trim();
    if (!hbl) {
      setState("bad", "번호 필요");
      showMsg("HBL(운송장번호)을 입력해줘.", "err");
      return;
    }
    hideMsg();
    $("result").innerHTML = "";
    setState("", "조회 중");
    $("btn").disabled = true;
    $("btn").textContent = "조회중…";

    const yearNow = new Date().getFullYear();
    const years = [yearNow, yearNow-1, yearNow-2, yearNow-3, yearNow-4, yearNow-5];

    let lastErr = null;

    for (const y of years) {
      try {
        const { xmlText, url } = await fetchXml(hbl, y);
        const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
        const data = parse(xmlDoc, hbl);

        // If notice says error or tCnt=0, try next year
        if (data.ntce || data.tCnt === "0") {
          lastErr = new Error(data.ntce || `tCnt=0 (year=${y})`);
          continue;
        }

        setState("ok", "조회 완료");
        render(data, xmlText, y, url);
        $("btn").disabled = false;
        $("btn").textContent = "조회";
        return;
      } catch (e) {
        lastErr = e;
        continue;
      }
    }

    setState("bad", "조회 실패");
    showMsg(
      `여러 연도(${years.join(", ")})로 시도했는데 결과를 못 찾았어.<br/>` +
      `에러/힌트: <span class="mono">${esc(String(lastErr?.message || lastErr || "-"))}</span>`,
      "err"
    );
    $("btn").disabled = false;
    $("btn").textContent = "조회";
  }

  $("btn").addEventListener("click", query);
  $("hbl").addEventListener("keydown", (e) => {
    if (e.key === "Enter") query();
  });

})();
</script>
</body>
</html>
