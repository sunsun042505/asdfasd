<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>선우택배 · 통관 진행 조회</title>
<style>
  :root{
    --bg0:#0b1220;
    --bg1:#0e172a;
    --card:rgba(255,255,255,.06);
    --card2:rgba(255,255,255,.08);
    --line:rgba(255,255,255,.10);
    --text:#e8eefc;
    --muted:rgba(232,238,252,.72);
    --muted2:rgba(232,238,252,.55);
    --ok:#44d19d;
    --warn:#ffcc66;
    --bad:#ff6b6b;
    --shadow:0 22px 80px rgba(0,0,0,.48);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 520px at 18% -10%, rgba(92,124,250,.28), transparent 60%),
      radial-gradient(900px 520px at 95% 0%, rgba(55,214,122,.22), transparent 58%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    min-height:100vh;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:22px 18px 80px}
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:16px 18px;
    border:1px solid var(--line);
    border-radius:22px;
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    box-shadow: var(--shadow);
  }
  .brand{display:flex; flex-direction:column; gap:3px}
  .brand .t{font-weight:900; letter-spacing:-.2px; font-size:18px}
  .brand .s{font-size:12px; color:var(--muted2)}
  .ver{
    font-size:12px; color:var(--muted);
    padding:6px 10px; border:1px solid var(--line);
    border-radius:999px; background:rgba(0,0,0,.18)
  }
  .panel{margin-top:14px; padding:16px 18px; border:1px solid var(--line); border-radius:22px; background:rgba(255,255,255,.05)}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end}
  label{display:block; font-size:12px; color:var(--muted2); margin:0 0 6px 2px}
  input{
    width:360px; max-width:100%;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    color:var(--text);
    outline:none;
    font-size:14px;
  }
  input::placeholder{color:rgba(232,238,252,.38)}
  .btn{
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(135deg, rgba(92,124,250,.95), rgba(55,214,122,.72));
    color:#07101f;
    font-weight:900;
    cursor:pointer;
    user-select:none;
  }
  .btn:active{transform:translateY(1px)}
  .ghost{
    background:rgba(255,255,255,.06);
    color:var(--text);
  }
  .hint{font-size:12px;color:var(--muted2); margin-top:10px; line-height:1.5}
  .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
  .chip{
    font-size:12px; color:var(--muted);
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.18);
  }
  .grid{
    margin-top:14px;
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:12px;
  }
  @media (max-width: 900px){
    .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
  }
  @media (max-width: 560px){
    .grid{grid-template-columns: 1fr;}
  }
  .card{
    padding:14px 14px;
    border-radius: var(--radius);
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    box-shadow: 0 14px 45px rgba(0,0,0,.20);
    min-height:76px;
  }
  .k{font-size:12px; color:var(--muted2); margin-bottom:6px}
  .v{font-weight:900; letter-spacing:-.2px}
  .v.small{font-weight:800; font-size:13px; color:var(--text)}
  .v.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .sep{height:1px;background:var(--line);margin:14px 0}
  .tableWrap{
    margin-top:14px;
    border:1px solid var(--line);
    border-radius: 22px;
    overflow:hidden;
    background: rgba(0,0,0,.16);
  }
  table{width:100%; border-collapse:collapse}
  thead th{
    text-align:left;
    font-size:12px;
    color:var(--muted2);
    font-weight:800;
    padding:12px 14px;
    background: rgba(255,255,255,.06);
    border-bottom:1px solid var(--line);
  }
  tbody td{
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.06);
    vertical-align:top;
    font-size:13px;
    color:var(--text);
  }
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .muted{color:var(--muted2)}
  .err{
    margin-top:12px;
    border:1px solid rgba(255,107,107,.35);
    background: rgba(255,107,107,.08);
    color: rgba(255,230,230,.96);
    padding:12px 14px;
    border-radius:18px;
    white-space:pre-wrap;
    display:none;
  }
  details{
    margin-top:14px;
    border:1px solid var(--line);
    border-radius:22px;
    overflow:hidden;
    background: rgba(255,255,255,.03);
  }
  summary{
    list-style:none;
    cursor:pointer;
    padding:12px 14px;
    font-weight:900;
    color:var(--muted);
    display:flex; align-items:center; justify-content:space-between;
  }
  summary::-webkit-details-marker{display:none}
  pre{
    margin:0;
    padding:14px;
    font-size:12px;
    color:rgba(232,238,252,.86);
    overflow:auto;
    background: rgba(0,0,0,.22);
    border-top:1px solid var(--line);
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="t">통관 진행 조회</div>
        <div class="s">HBL(운송장번호)만 입력하면 연도는 자동으로 찾아요</div>
      </div>
      <div class="ver" id="ver">v5.8-hbl-only (2026-01-08)</div>
    </div>

    <div class="panel">
      <div class="row">
        <div>
          <label>운송장번호(HBL)</label>
          <input id="hbl" inputmode="numeric" placeholder="예) 300046199451" />
        </div>
        <button class="btn" id="btn">조회</button>
        <button class="btn ghost" id="btnCopy">URL 복사</button>
      </div>
      <div class="hint">
        • 이 페이지는 <b>운송장번호를 화면에 표시</b>합니다(내부 확인용).<br/>
        • 조회가 안 되면 대개 연도(blYy) 문제라서, 내부에서 <b>올해 → 과거</b> 순으로 자동 시도합니다.
      </div>

      <div class="chips" id="chips" style="display:none">
        <div class="chip">호출: <span id="called" class="muted"></span></div>
        <div class="chip">사용 연도(blYy): <b id="usedYear">-</b></div>
        <div class="chip">이력 건수: <b id="cnt">-</b></div>
      </div>

      <div class="err" id="err"></div>

      <div id="result" style="display:none">
        <div class="grid" id="grid"></div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:28%">처리단계</th>
                <th style="width:18%">처리일시</th>
                <th style="width:28%">장치장/장치위치</th>
                <th>반출입(처리)내용</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <details>
          <summary>
            <span>원문(XML)</span>
            <span class="muted">펼치기/접기</span>
          </summary>
          <pre id="raw"></pre>
        </details>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const ENDPOINT = "/.netlify/functions/unipass";

  function cleanDigits(s){
    return (s||"").toString().replace(/[^\d]/g,"").trim();
  }

  function fmt14(s){
    s = cleanDigits(s);
    if (s.length !== 14) return (s||"").toString().trim() || "-";
    const y=s.slice(0,4), m=s.slice(4,6), d=s.slice(6,8);
    const hh=s.slice(8,10), mm=s.slice(10,12), ss=s.slice(12,14);
    return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
  }

  function fmt8(s){
    s = cleanDigits(s);
    if (s.length !== 8) return (s||"").toString().trim() || "-";
    return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
  }

  function xmlText(node, tag){
    const el = node.getElementsByTagName(tag)[0];
    return el ? (el.textContent || "").trim() : "";
  }

  function pick(node, tags){
    for (const t of tags){
      const v = xmlText(node, t);
      if (v) return v;
    }
    return "";
  }

  function looksLikeCode(s){
    if (!s) return true;
    const t = s.trim();
    if (/^\d{8,14}$/.test(t)) return true;              // 날짜/시간
    if (/^[A-Z0-9]{8,}$/.test(t)) return true;          // 영문+숫자 코드
    if (/^[0-9]{6,}[A-Z0-9\-]*$/.test(t)) return true;  // 숫자 기반 코드
    return false;
  }

  function parse(xmlDoc, hbl){
    const root = xmlDoc;
    const vo = root.getElementsByTagName("cargCsclPrgsInfoQryVo")[0] || root;

    const csclPrgsStts = pick(root, ["csclPrgsStts"]) || pick(vo, ["csclPrgsStts", "prgsStts", "prgsStCd"]);
    const prcsDttm = fmt14(pick(vo, ["prcsDttm", "prcsDt", "dttm"]));

    // ✅ 세관명: XML에 실제로 있음 (cstmNm / cstmCd)
    const cstmNm = pick(vo, ["cstmNm"]) || pick(root, ["cstmNm"]);
    const cstmCd = pick(vo, ["cstmCd"]) || pick(root, ["cstmCd"]);
    const customs = cstmNm ? `${cstmNm}${cstmCd ? " ("+cstmCd+")" : ""}` : (cstmCd ? `세관코드 ${cstmCd}` : "-");

    // ✅ 특송업체 / 선사·항공사 (정확 태그 고정)
    const express = pick(vo, ["frwrEntsConm"]) || pick(root, ["frwrEntsConm"]) || "-";
    const carrier = pick(vo, ["shcoFlco", "shcoFlcoNm"]) || pick(root, ["shcoFlco", "shcoFlcoNm"]) || "-";

    const prnm = pick(vo, ["prnm", "gdsNm", "prdtNm"]) || "-";
    const etprDt = fmt8(pick(vo, ["etprDt", "etprDt8", "etprYmd"]));

    const dtls = Array.from(root.getElementsByTagName("cargCsclPrgsInfoDtlQryVo"));

    const steps = dtls.map(n => {
      // ✅ 처리단계는 여기 태그가 핵심: cargTrcnRelaBsopTpcd (네 XML에 이렇게 들어있음)
      let stage = pick(n, ["cargTrcnRelaBsopTpcdNm", "cargTrcnRelaBsopTpcd", "prcsSttsNm", "prcsStts"]);
      // 부가사항은 단계가 아니라 보통 비고로
      const extra = pick(n, ["bfhnGdncCn"]);
      const rlbr = pick(n, ["rlbrCn"]);
      if (!stage && extra) stage = "부가사항";

      // 단계에 코드/시간이 올라오면 버림
      if (looksLikeCode(stage)) stage = "";
      const time = fmt14(pick(n, ["prcsDttm", "rlbrDttm", "prcsDt"]));
      const place = pick(n, ["shedNm", "shedSgn", "cstmNm"]) || "-";
      const remark = rlbr || extra || "-";

      return { stage: stage || "-", time, place, remark };
    });

    // 시간 기준 내림차순 정렬(유니패스 화면처럼 최신이 위)
    steps.sort((a,b) => {
      const ad = cleanDigits(a.time), bd = cleanDigits(b.time);
      return (bd||"").localeCompare(ad||"");
    });

    return { hbl, csclPrgsStts, prcsDttm, customs, express, carrier, prnm, etprDt, steps };
  }

  function showErr(msg){
    const el = $("err");
    el.style.display = "block";
    el.textContent = msg;
  }

  function clearErr(){
    $("err").style.display="none";
    $("err").textContent="";
  }

  function setResultVisible(on){
    $("result").style.display = on ? "block" : "none";
    $("chips").style.display = on ? "flex" : "none";
  }

  function buildCards(d){
    const cards = [
      ["특송업체", d.express, true],
      ["선사/항공사", d.carrier, true],
      ["세관", d.customs, true],
      ["상태", d.csclPrgsStts || "-", false],
      ["처리", d.prcsDttm || "-", false],
      ["품명", d.prnm || "-", false],
      ["입항일", d.etprDt || "-", false],
      ["HBL", d.hbl || "-", true]
    ];
    $("grid").innerHTML = cards.map(([k,v,mono]) => `
      <div class="card">
        <div class="k">${k}</div>
        <div class="v ${mono ? "mono" : ""}">${escapeHtml(v)}</div>
      </div>
    `).join("");
  }

  function buildTable(steps){
    $("tbody").innerHTML = steps.map(s => `
      <tr>
        <td><b>${escapeHtml(s.stage)}</b></td>
        <td>${escapeHtml(s.time)}</td>
        <td class="muted">${escapeHtml(s.place)}</td>
        <td class="muted">${escapeHtml(s.remark)}</td>
      </tr>
    `).join("");
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  async function fetchXml(url){
    const res = await fetch(url, { method:"GET" });
    const txt = await res.text();
    if (!res.ok) {
      const msg = `HTTP ${res.status}\n${url}\n\n${txt.slice(0,400)}`;
      throw new Error(msg);
    }
    return txt;
  }

  async function queryHbl(hbl){
    const y = new Date().getFullYear();
    const years = [y, y-1, y-2, y-3, y-4, y-5];
    let lastErr = null;

    for (const blYy of years){
      // 두 가지 시그니처를 모두 만족하도록 no/hblNo 둘 다 전달
      const url = `${ENDPOINT}?type=hbl&no=${encodeURIComponent(hbl)}&hblNo=${encodeURIComponent(hbl)}&blYy=${blYy}`;
      $("called").textContent = url;
      try{
        const xmlText = await fetchXml(url);
        const dom = new DOMParser().parseFromString(xmlText, "application/xml");
        // tCnt가 0이면 다음 연도 시도
        const tCnt = pick(dom, ["tCnt"]);
        if (tCnt && tCnt.trim() === "0") {
          lastErr = new Error(`tCnt=0 (${blYy})`);
          continue;
        }
        return { xmlText, dom, usedYear: blYy.toString() };
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("조회 실패");
  }

  async function run(){
    clearErr();
    setResultVisible(false);

    const hbl = cleanDigits($("hbl").value);
    if (!hbl || hbl.length < 8){
      showErr("운송장번호(HBL)를 숫자로 입력해줘.");
      return;
    }

    $("btn").disabled = true;
    $("btn").textContent = "조회중…";

    try{
      const { xmlText, dom, usedYear } = await queryHbl(hbl);
      $("usedYear").textContent = usedYear;

      const data = parse(dom, hbl);

      // 이력 건수
      $("cnt").textContent = (data.steps || []).length.toString();

      buildCards(data);
      buildTable(data.steps || []);
      $("raw").textContent = xmlText;

      setResultVisible(true);
    }catch(e){
      showErr(String(e?.message || e));
    }finally{
      $("btn").disabled = false;
      $("btn").textContent = "조회";
    }
  }

  $("btn").addEventListener("click", run);
  $("hbl").addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") run();
  });

  $("btnCopy").addEventListener("click", async () => {
    const hbl = cleanDigits($("hbl").value);
    const y = new Date().getFullYear();
    const url = `${location.origin}${ENDPOINT}?type=hbl&no=${encodeURIComponent(hbl||"")}&hblNo=${encodeURIComponent(hbl||"")}&blYy=${y}`;
    try{
      await navigator.clipboard.writeText(url);
      $("btnCopy").textContent = "복사됨!";
      setTimeout(()=> $("btnCopy").textContent = "URL 복사", 900);
    }catch(_){
      alert(url);
    }
  });

})();
</script>
</body>
</html>
