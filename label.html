<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <title>라벨 출력 | 선우택배</title>

  <!-- libs (CDN) -->
  <!-- NOTE: We rely on window.onload so these can be defer -->
  <script defer src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg1:#071527;
      --bg2:#041a2c;
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.62);
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
      --shadow:0 20px 60px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 70% 35%, rgba(0,180,255,.22), transparent 60%),
        radial-gradient(900px 600px at 35% 65%, rgba(110,231,255,.16), transparent 62%),
        radial-gradient(900px 600px at 60% 70%, rgba(120,90,255,.14), transparent 62%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{
      max-width: 1100px;
      margin:0 auto;
      padding: 24px 16px 36px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 14px 16px;
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap: 12px; min-width:0;
    }
    .logo{
      width: 34px; height: 34px; border-radius: 10px;
      background: linear-gradient(135deg, rgba(110,231,255,.9), rgba(102,242,194,.9));
      box-shadow: 0 10px 25px rgba(110,231,255,.16);
      flex:0 0 auto;
    }
    .brand h1{margin:0; font-size: 15px; letter-spacing:-.2px}
    .brand p{
      margin: 4px 0 0; font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 680px;
    }
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
    }
    .btn.primary{border-color: rgba(110,231,255,.28)}
    .btn:active{transform: translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px;
    }
    .status{
      font-size: 12px;
      color: rgba(234,241,255,.72);
      line-height:1.45;
      font-variant-numeric: tabular-nums;
      white-space: pre-wrap;
    }

    /* Label paper */
    .stage{
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 16px 0;
    }
    .paper{
      width: 390px;
      background: #fff;
      color:#111;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      padding: 14px 14px 12px;
    }
    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .title{
      font-size: 12px;
      letter-spacing:.6px;
      color:#444;
      font-weight:800;
    }
    .typeTag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      font-weight: 800;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      color:#111;
      white-space:nowrap;
    }
    .bigNo{
      font-size: 24px;
      font-weight: 900;
      letter-spacing: .4px;
      margin: 4px 0 8px;
      word-break: break-all;
    }
    .divider{
      height:1px;
      background:#e5e7eb;
      margin: 8px 0 10px;
    }
    .kv2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 14px;
    }
    .k{
      font-size: 11px;
      color:#444;
      font-weight:800;
      margin-bottom: 2px;
    }
    .v{
      font-size: 12px;
      color:#111;
      font-weight:700;
      min-height: 16px;
      word-break: break-word;
    }
    .kv1{
      margin-top: 10px;
    }
    .small{
      font-size: 11px;
      color:#555;
      font-weight:700;
    }
    .codeRow{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      margin-top: 12px;
    }
    .barcodeWrap{
      flex: 1;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:flex-end;
    }
    svg{width:100%}
    .mono{
      text-align:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      font-weight: 900;
      margin-top: 4px;
    }
    .qrWrap{
      width: 104px;
      height: 104px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .qrWrap canvas, .qrWrap img{width: 96px; height:96px}
    .warn{
      margin-top:8px;
      font-size:11px;
      color:#555;
      line-height:1.35;
    }

    @media print{
      body{background:#fff}
      .top, .card{display:none !important}
      .wrap{padding:0}
      .stage{padding:0}
      .paper{
        width: 58mm;
        border-radius: 0;
        box-shadow: none;
        padding: 3mm;
      }
      .qrWrap{border:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>운송장 라벨 출력</h1>
          <p>label.html?invoice_no=운송장번호 또는 label.html?waybill=운송장번호 또는 label.html?payload=...</p>
        </div>
      </div>
      <div class="btns">
        <button class="btn" id="btnReload">새로고침</button>
        <button class="btn primary" id="btnShare">공유(앱)</button>
        <button class="btn" id="btnJpg">JPG 저장</button>
        <button class="btn" id="btnPrint">인쇄</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="stage">
          <div class="paper" id="paper">
            <div class="row" style="align-items:center">
              <div class="title">SUNWOO TAKBAE</div>
              <div class="typeTag" id="typeTag">-</div>
            </div>

            <div class="row" style="align-items:flex-start">
              <div style="flex:1; min-width:0">
                <div class="bigNo" id="wbText">-</div>
              </div>
              <div class="qrWrap" title="QR: 배송조회 링크">
                <div id="qr" style="font-weight:900;font-size:12px;color:#555">로딩…</div>
              </div>
            </div>

            <div class="small" style="margin-top:-2px">
              배송사: <span id="carrier">-</span>
            </div>

            <div class="divider"></div>

            <div class="kv2">
              <div>
                <div class="k">보내는분</div>
                <div class="v" id="sName">-</div>
                <div class="v" id="sPhone" style="font-weight:800">-</div>
              </div>
              <div>
                <div class="k">받는분</div>
                <div class="v" id="rName">-</div>
                <div class="v" id="rPhone" style="font-weight:800">-</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="kv2">
              <div>
                <div class="k">접수지점</div>
                <div class="v" id="pickupStore">-</div>
              </div>
              <div>
                <div class="k">도착점포</div>
                <div class="v" id="dropStore">-</div>
              </div>
            </div>

            <div class="kv1">
              <div class="k">주소 / 비고</div>
              <div class="v" id="addrMemo">-</div>
            </div>

            <div class="kv2" style="margin-top:10px">
              <div>
                <div class="k">무게(kg)</div>
                <div class="v" id="weightKg">-</div>
              </div>
              <div>
                <div class="k">종류</div>
                <div class="v" id="pkgKind">-</div>
              </div>
            </div>

            <div class="codeRow">
              <div class="barcodeWrap">
                <svg id="barcode"></svg>
                <div class="mono" id="wbMono">-</div>
              </div>
            </div>

            <div class="warn" id="hintLine"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="status" id="statusText">준비 중…</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function normNo(v){
    return String(v ?? "").trim().replace(/[^0-9]/g, "");
  }
  function qp(name){
    return new URLSearchParams(location.search).get(name) || "";
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function apiJson(path, opts={}, timeoutMs=9000){
    const u = new URL(path, location.origin);
    u.searchParams.set("_ts", String(Date.now())); // cache bust
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(u.toString(), {
        ...opts,
        headers: {
          "cache-control":"no-store",
          "pragma":"no-cache",
          ...(opts.headers||{})
        },
        signal: ctrl.signal
      });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = text; }
      return { ok: res.ok, status: res.status, data };
    } finally {
      clearTimeout(t);
    }
  }

  function decodeB64Url(input){
    try{
      const s = String(input||"").replace(/-/g,'+').replace(/_/g,'/');
      const pad = s.length % 4 ? '='.repeat(4 - (s.length % 4)) : '';
      const str = atob(s + pad);
      const bytes = Uint8Array.from(str, c => c.charCodeAt(0));
      return new TextDecoder().decode(bytes);
    }catch(e){ return ""; }
  }
  function parsePayload(){
    const p = qp("payload");
    if(!p) return null;
    try{
      const jsonStr = decodeB64Url(p);
      if(!jsonStr) return null;
      return JSON.parse(jsonStr);
    }catch(e){ return null; }
  }
  function parseLocalPayload(wb){
    try{
      const s = localStorage.getItem(`SW_LABEL_PAYLOAD_${wb}`);
      if(!s) return null;
      return JSON.parse(s);
    }catch(e){ return null; }
  }

  function setText(id, v){
    const el = $(id);
    if(!el) return;
    el.textContent = (v===undefined || v===null || v==="") ? "-" : String(v);
  }

  function typeLabel(type){
    const t = String(type||"").toUpperCase();
    if(t==="DOMESTIC") return "국내택배";
    if(t==="INTERNATIONAL") return "국제택배";
    if(t==="ECONOMY_CVS") return "반값택배";
    if(t==="RETURN") return "반품/반송";
    return "-";
  }
  function carrierLabel(type){
    const t = String(type||"").toUpperCase();
    if(t==="ECONOMY_CVS") return "선우네트웍스";
    if(t==="INTERNATIONAL") return "네버랩인터내셔널에어포트(주)(인천국제공항)";
    return "선우택배";
  }

  function pick(obj, keys){
    for(const k of keys){
      const v = obj?.[k];
      if(v!==undefined && v!==null && v!=="") return v;
    }
    return "";
  }
  function pickName(rec, which){
    const o = rec?.[which];
    if(o && typeof o === "object"){
      const name = pick(o, ["name","storeName","branchName"]) || pick(rec, [which+"Name", which+"_name"]);
      return name || "-";
    }
    // sometimes stored as senderName/senderPhone
    const name2 = pick(rec, [which+"Name", which+"_name"]);
    return name2 || "-";
  }
  function pickPhone(rec, which){
    const o = rec?.[which];
    if(o && typeof o === "object"){
      const phone = pick(o, ["phone","tel","mobile"]) || pick(rec, [which+"Phone", which+"_phone"]);
      return phone || "-";
    }
    const phone2 = pick(rec, [which+"Phone", which+"_phone"]);
    return phone2 || "-";
  }

  function candidates(rec){
    const keys = ["waybillNo","invoiceNo","invoice_no","waybill","wb","reserveNo","originalWaybillNo"];
    const out = [];
    for (const k of keys){
      if(rec && rec[k]) out.push(normNo(rec[k]));
    }
    return out.filter(Boolean);
  }

  function renderBarcodeAndQR(wb){
    setText("wbText", wb);
    setText("wbMono", wb);

    // Barcode
    try{
      if(window.JsBarcode){
        JsBarcode("#barcode", wb, {
          format: "CODE128",
          lineColor: "#111",
          width: 2,
          height: 58,
          displayValue: false,
          margin: 0
        });
      } else {
        // keep empty but not crash
      }
    }catch(e){}

    // QR to tracking link
    const url = new URL("tracking.html", location.origin);
    url.searchParams.set("invoice_no", wb);
    const qrHost = $("qr");
    qrHost.innerHTML = "";
    try{
      if(window.QRCode && window.QRCode.toCanvas){
        QRCode.toCanvas(url.toString(), { width: 96, margin: 1 }, (err, canvas)=>{
          if(!err && canvas) qrHost.appendChild(canvas);
          else qrHost.textContent = "QR 생성 실패";
        });
      } else {
        qrHost.textContent = "QR 로딩중…";
      }
    }catch(e){
      qrHost.textContent = "QR 생성 실패";
    }
  }

  function looksLikeStoreName(s){
    const v = String(s||"").trim();
    if(!v) return false;
    // heuristics: contains "지점/점포/편의점/센터/터미널" and not looks like a street address
    const hasWord = /(지점|점포|편의점|센터|터미널)/.test(v);
    const looksAddress = /(\d{2,3}\-?\d{2,4}|\d{2,4}동|\d{1,4}호|로|길|번길)/.test(v);
    return hasWord && !looksAddress;
  }

  function normalizeLabelFields(rec){
    const t = String(rec?.type || rec?.serviceType || rec?.service || "").toUpperCase();

    // pickup/drop store candidates
    let pickupStore =
      pick(rec, ["storeName","pickupStoreName","originStoreName"]) ||
      pick(rec?.issuedStore, ["name"]) ||
      pick(rec?.sender, ["storeName","name"]) ||
      "";

    let dropStore =
      pick(rec, ["destStoreName","dropoffStoreName","arrivalStoreName","receiverStoreName","toStoreName","destinationStoreName"]) ||
      pick(rec?.receiverStore, ["name"]) ||
      pick(rec?.receiver, ["storeName"]) ||
      "";

    // address + memo
    let addr =
      pick(rec, ["addr","address","cvsAddr","storeAddr"]) ||
      pick(rec?.receiver, ["address","addr"]) ||
      "";

    const memo = pick(rec, ["memo","note","remark"]) || "";

    // Special: ECONOMY_CVS - sometimes they mistakenly saved "addr" as store-name or "주소/비고" confusion.
    if(t === "ECONOMY_CVS"){
      if(!dropStore && looksLikeStoreName(addr)){
        // addr is actually store name
        dropStore = addr;
        addr = ""; // keep memo as address/memo
      }
      // If dropStore still empty but memo looks like store name, lift it
      if(!dropStore && looksLikeStoreName(memo)){
        dropStore = memo;
      }
    }

    // Show "주소/비고" as addr + memo (but avoid duplicating store names)
    const parts = [];
    if(addr) parts.push(addr);
    if(memo && memo !== addr) parts.push(memo);
    const addrMemo = parts.join(" / ");

    // package
    const pkg = rec?.package || {};
    const weightKg =
      pick(pkg, ["weightKg","weight"]) ||
      pick(rec, ["weightKg","weight"]) || "";

    const kind =
      pick(pkg, ["kind","type"]) ||
      pick(rec, ["pkgKind","kind"]) || "";

    // sender/receiver
    const sName = pickName(rec, "sender");
    const sPhone = pickPhone(rec, "sender");
    const rName = pickName(rec, "receiver");
    const rPhone = pickPhone(rec, "receiver");

    return { t, pickupStore, dropStore, addrMemo, weightKg, kind, sName, sPhone, rName, rPhone };
  }

  function applyRecord(rec, wb, sourceNote){
    const f = normalizeLabelFields(rec);
    setText("typeTag", typeLabel(f.t));
    setText("carrier", carrierLabel(f.t));

    setText("sName", f.sName);
    setText("sPhone", f.sPhone);
    setText("rName", f.rName);
    setText("rPhone", f.rPhone);

    setText("pickupStore", f.pickupStore || "-");
    setText("dropStore", f.dropStore || "-");
    setText("addrMemo", f.addrMemo || "-");
    setText("weightKg", (f.weightKg!=="" ? f.weightKg : "-"));
    setText("pkgKind", f.kind || "-");

    renderBarcodeAndQR(wb);

    const hint = [];
    if(sourceNote.includes("payload") && (f.sName==="-" || f.rName==="-" )) hint.push("※ 서버 조회 후 정보가 더 채워질 수 있음");
    $("hintLine").textContent = hint.join(" ");
    $("statusText").textContent = `라벨 렌더 ✅\n- source: ${sourceNote}\n- type: ${f.t || "-"}\n- waybill: ${wb}`;
  }

  function isPayloadPartial(rec){
    // payload from kiosk may not include sender/receiver
    const hasSender = !!(rec?.sender && typeof rec.sender === "object" && rec.sender.name);
    const hasReceiver = !!(rec?.receiver && typeof rec.receiver === "object" && rec.receiver.name);
    return !(hasSender && hasReceiver);
  }

  async function loadRecord(wb){
    renderBarcodeAndQR(wb);

    // 0) try payload first for immediate render (but DO NOT stop here; we will still fetch server to enrich)
    const payload = parsePayload() || parseLocalPayload(wb);
    if(payload){
      const pNo = normNo(payload.waybillNo||payload.invoiceNo||payload.invoice_no||payload.wb||payload.waybill);
      if(pNo && pNo === wb){
        applyRecord(payload, wb, isPayloadPartial(payload) ? "payload(부분) → 서버 조회 중…" : "payload");
      }
    }

    // 1) server fetch with retry (eventual consistency)
    const tryCount = 10;
    for(let i=0;i<tryCount;i++){
      // A) dedicated byWaybill endpoint (if present)
      const r1 = await apiJson(`/api/reservations/byWaybill/${encodeURIComponent(wb)}`);
      if(r1.ok && r1.data && typeof r1.data === "object"){
        applyRecord(r1.data, wb, "byWaybill");
        return;
      }

      // B) list endpoint
      const r2 = await apiJson(`/api/reservations`);
      if(r2.ok && Array.isArray(r2.data)){
        const found = r2.data.find(x => candidates(x).includes(wb));
        if(found){ applyRecord(found, wb, "reservations(list)"); return; }
      }

      // C) KV store
      const key = "DELIVERY_RESERVATIONS_V1";
      const r3 = await apiJson(`/api/kv/get?key=${encodeURIComponent(key)}`);
      let arr = null;
      if(r3.ok){
        const v = (r3.data && typeof r3.data === "object" && ("value" in r3.data)) ? r3.data.value : r3.data;
        if(Array.isArray(v)) arr = v;
        else if(typeof v === "string"){
          try{
            const pv = JSON.parse(v);
            if(Array.isArray(pv)) arr = pv;
          }catch(e){}
        }
      }
      if(arr){
        const found = arr.find(x => candidates(x).includes(wb));
        if(found){ applyRecord(found, wb, "kv:DELIVERY_RESERVATIONS_V1"); return; }
      }

      $("statusText").textContent =
        `조회 중… (${i+1}/${tryCount})\n- waybill: ${wb}\n- 방금 발급한 송장은 서버 반영까지 몇 초 걸릴 수 있어.`;
      await sleep(700);
    }

    // If we already rendered payload, keep it; else show error
    if(!payload){
      $("statusText").textContent =
        `운송장 정보를 서버/로컬에서 찾지 못했어.\n- waybill: ${wb}\n\n그래도 바코드/QR은 표시했어.`;
    } else {
      $("statusText").textContent += `\n\n서버에서 못 찾았어서(아직 저장 전일 수 있음) payload로만 표시 중이야.`;
    }
  }

  async function exportBlob(mime="image/jpeg"){
    const node = $("paper");
    const canvas = await html2canvas(node, { backgroundColor: "#ffffff", scale: 2, useCORS: true });
    return await new Promise(resolve => canvas.toBlob(resolve, mime, 0.92));
  }

  function getWaybillFromQuery(){
    return normNo(
      qp("invoice_no") ||
      qp("invoiceNo") ||
      qp("waybill") ||
      qp("waybillNo") ||
      qp("waybill_no") ||
      qp("invoice_no") ||
      qp("wb")
    );
  }

  // Start only after libs are loaded (fixes QR showing "QR" and missing barcode)
  window.addEventListener("load", () => {
    $("btnReload").addEventListener("click", ()=> location.reload());
    $("btnPrint").addEventListener("click", ()=> window.print());

    $("btnJpg").addEventListener("click", async ()=>{
      try{
        const blob = await exportBlob("image/jpeg");
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `label_${$("wbText").textContent || "waybill"}.jpg`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
        $("statusText").textContent += "\n\nJPG 저장 완료";
      }catch(e){
        $("statusText").textContent += "\n\nJPG 저장 실패(브라우저 권한/지원 확인)";
      }
    });

    $("btnShare").addEventListener("click", async ()=>{
      try{
        if(!navigator.share){ $("statusText").textContent += "\n\n이 브라우저는 공유를 지원하지 않아."; return; }
        const blob = await exportBlob("image/jpeg");
        const file = new File([blob], `label_${$("wbText").textContent || "waybill"}.jpg`, { type: "image/jpeg" });
        await navigator.share({ files: [file], title: "운송장 라벨", text: "라벨 이미지를 프린터 앱(Fun Print 등)으로 공유해 출력해줘." });
      }catch(e){}
    });

    const wb = getWaybillFromQuery();
    if(!wb){
      $("statusText").textContent = "운송장 번호가 없어.\nlabel.html?invoice_no=81... 또는 label.html?waybill=81... 또는 label.html?payload=... 로 열어줘.";
      renderBarcodeAndQR("000000000000000000");
    } else {
      loadRecord(wb);
    }
  });
})();
</script>
</body>
</html>
