<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <title>허브터미널 작업 | 선우택배</title>
  <style>
    :root{
      --bg1:#071527; --bg2:#041a2c;
      --text:#eaf1ff; --muted:rgba(234,241,255,.62);
      --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.10);
      --shadow:0 20px 60px rgba(0,0,0,.35);
      --r:18px;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 70% 35%, rgba(0,180,255,.22), transparent 60%),
        radial-gradient(900px 600px at 35% 65%, rgba(110,231,255,.16), transparent 62%),
        radial-gradient(900px 600px at 60% 70%, rgba(120,90,255,.14), transparent 62%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:1180px;margin:0 auto;padding:22px 14px 36px;display:flex;flex-direction:column;gap:12px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--border);box-shadow:var(--shadow);backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg, rgba(110,231,255,.9), rgba(102,242,194,.9));flex:0 0 auto}
    .brand h1{margin:0;font-size:15px;letter-spacing:-.2px}
    .brand p{margin:4px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      padding:9px 11px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);color:var(--text);cursor:pointer;
      font-weight:800;font-size:12px;
      text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }
    .btn.primary{border-color: rgba(110,231,255,.32)}
    .btn.danger{border-color: rgba(239,68,68,.35)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:12px;align-items:start}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      padding:14px;
    }
    .sectionTitle{font-size:12px;color:rgba(234,241,255,.8);font-weight:900;margin:0 0 8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    label{font-size:11px;color:rgba(234,241,255,.72);font-weight:800}
    input, textarea, select{
      width:100%;
      padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);color:var(--text);outline:none;
      font-weight:800;font-size:13px;
    }
    textarea{min-height:120px;resize:vertical}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;font-weight:900}
    .pill.ok{border-color: rgba(34,197,94,.35)}
    .pill.warn{border-color: rgba(245,158,11,.35)}
    .pill.bad{border-color: rgba(239,68,68,.35)}
    .kvs{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .kv{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
    .kv .k{font-size:11px;color:rgba(234,241,255,.65);font-weight:900}
    .kv .v{font-size:13px;font-weight:900;margin-top:6px;word-break:break-word}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .events{margin-top:10px;border-top:1px solid rgba(255,255,255,.10);padding-top:10px;display:flex;flex-direction:column;gap:8px}
    .ev{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16)}
    .ev .t{font-size:11px;color:rgba(234,241,255,.65);font-weight:900}
    .ev .m{margin-top:6px;font-weight:900;font-size:13px}
    .banner{
      position:sticky;top:10px;z-index:50;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.28);backdrop-filter: blur(10px);
      display:none;align-items:center;justify-content:space-between;gap:10px;
    }
    .banner.show{display:flex}
    .banner .msg{font-size:12px;font-weight:900;color:rgba(234,241,255,.92)}
    .badgeDot{width:10px;height:10px;border-radius:999px;flex:0 0 auto}
    .dotOk{background:var(--ok)} .dotWarn{background:var(--warn)} .dotBad{background:var(--bad)}
    .railGrid{display:grid;grid-template-columns: repeat(5, 1fr);gap:8px}
    .railBtn{
      padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);cursor:pointer;text-align:center;
      font-weight:1000;font-size:12px;user-select:none;
    }
    .railBtn.ok{outline:2px solid rgba(34,197,94,.35)}
    .railBtn.warn{outline:2px solid rgba(245,158,11,.35)}
    .railBtn.bad{outline:2px solid rgba(239,68,68,.35)}
    .help{font-size:12px;color:rgba(234,241,255,.70);line-height:1.45;white-space:pre-wrap}
    .small{font-size:11px;color:rgba(234,241,255,.62);font-weight:800}
    .rightActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;
      align-items:center;justify-content:center;padding:16px;z-index:100;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(520px, 100%); border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14); box-shadow:var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 8px;font-size:14px}
    .modal .muted{font-size:12px;color:rgba(234,241,255,.70);line-height:1.5}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner" id="banner">
      <div class="row" style="gap:10px">
        <div class="badgeDot" id="bannerDot"></div>
        <div class="msg" id="bannerMsg">-</div>
      </div>
      <button class="btn" id="bannerClose">닫기</button>
    </div>

    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <h1>허브터미널 작업</h1>
          <p>기사코드 로그인 → 운송장 조회/입고/출고/분류/이동예정 + 일괄 처리 + 반송 생성 + 허브라벨</p>
        </div>
      </div>
      <div class="btns">
        <a class="btn" href="Workstatus.html">작업현황</a>
        <button class="btn" id="btnLogout">로그아웃</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="loginCard">
        <p class="sectionTitle">로그인</p>
        <div class="field">
          <label>기사 코드</label>
          <input id="courierCode" placeholder="예) H001" autocomplete="off" />
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnLogin">로그인</button>
        </div>
        <div class="help" style="margin-top:10px">
- 이 페이지는 허브 작업자(기사코드) 전용이야.
- 로그인은 브라우저 탭 단위(sessionStorage)라서, 닫으면 자동 로그아웃돼.
        </div>
      </div>

      <div class="card" id="mainCard" style="display:none">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <p class="sectionTitle">조회 / 처리</p>
            <div class="row" style="gap:10px">
              <span class="pill ok" id="whoPill">작업자: <span class="mono" id="who">-</span></span>
              <span class="pill" id="stagePill">상태: <span id="stageText">-</span></span>
            </div>
          </div>
          <div class="rightActions">
            <button class="btn" id="btnHubLabel" disabled>허브라벨</button>
            <button class="btn danger" id="btnReturn" disabled>배송불가/반송</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>운송장 번호</label>
            <input id="waybillInput" placeholder="스캔/입력 (숫자만)" autocomplete="off" />
          </div>
          <div class="field" style="max-width:160px">
            <label>레일 번호 (1~5)</label>
            <input id="railInput" placeholder="예) 1" inputmode="numeric" />
          </div>
          <div class="field" style="max-width:220px">
            <label>다음 이동 예정지(선택)</label>
            <select id="nextSelect">
              <option value="">(선택 안 함)</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:flex-end">
            <button class="btn primary" id="btnLookup">조회</button>
          </div>
        </div>

        <div class="kvs" style="margin-top:10px">
          <div class="kv">
            <div class="k">서비스</div>
            <div class="v" id="svc">-</div>
          </div>
          <div class="kv">
            <div class="k">운송장</div>
            <div class="v mono" id="wb">-</div>
          </div>
          <div class="kv">
            <div class="k">보내는분</div>
            <div class="v" id="sender">-</div>
          </div>
          <div class="kv">
            <div class="k">받는분</div>
            <div class="v" id="receiver">-</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnInbound" disabled>입고(간선하차)</button>
          <button class="btn" id="btnOutbound" disabled>출고(간선상차)</button>
          <button class="btn" id="btnSortDone" disabled>분류완료</button>
          <button class="btn" id="btnMovePlan" disabled>서브로 출발(이동예정)</button>
        </div>
        <div class="small" id="integrityHint" style="margin-top:8px">-</div>

        <div class="events" id="eventsBox">
          <p class="sectionTitle" style="margin:0">배송흐름(최근)</p>
          <div id="eventsList"></div>
        </div>
      </div>

      <div class="card" id="sideCard">
        <p class="sectionTitle">일괄 처리 / 레일 현황</p>

        <div class="field">
          <label>일괄 운송장 (줄바꿈/공백/쉼표 가능)</label>
          <textarea id="batchInput" placeholder="81...&#10;81...&#10;30..."></textarea>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnBatchLookup">일괄 조회</button>
          <button class="btn" id="btnBatchInbound">일괄 입고</button>
          <button class="btn" id="btnBatchOutbound">일괄 출고</button>
          <button class="btn" id="btnBatchSort">일괄 분류완료</button>
        </div>
        <div class="field" style="margin-top:10px">
          <label>일괄 레일 번호(1~5) (입고/출고/분류에 적용)</label>
          <input id="batchRail" placeholder="예) 2" inputmode="numeric" />
        </div>

        <div class="help" id="batchResult" style="margin-top:10px">-</div>

        <div style="margin-top:14px">
          <p class="sectionTitle">레일 1~5 작동 현황(편집)</p>
          <div class="railGrid" id="railGrid"></div>
          <div class="help" style="margin-top:10px">
- 초록: 정상 작동
- 빨강: 미작동
- 노랑: 고장(점검중)
(레일 버튼을 눌러 상태를 바꿀 수 있어)
          </div>
        </div>

        <div style="margin-top:14px">
          <p class="sectionTitle">허브터미널 목록(이동 예정지)</p>
          <div class="row">
            <div class="field">
              <label>추가할 이름</label>
              <input id="listAddName" placeholder="예) 의왕터미널 / 선우택배 의왕지점" />
            </div>
            <div style="display:flex;gap:8px;align-items:flex-end">
              <button class="btn" id="btnListAdd">추가</button>
            </div>
          </div>
          <div class="help" id="listHelp" style="margin-top:10px">-</div>
        </div>

      </div>
    </div>
  </div>

  <!-- return modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3>배송불가/반송 처리</h3>
      <div class="muted">허브에서 배송불가 처리 시, <b>반송 운송장</b>을 생성하고 원 운송장 배송흐름에 <b>반송접수</b> 이벤트가 추가돼.</div>
      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>사유(선택)</label>
          <select id="returnReason">
            <option value="">(직접 입력)</option>
            <option value="규격초과">규격초과</option>
            <option value="무게불일치">무게불일치</option>
            <option value="파손">파손</option>
            <option value="주소불명">주소불명</option>
            <option value="금지품">금지품</option>
            <option value="기타">기타</option>
          </select>
        </div>
        <div class="field">
          <label>사유(직접입력)</label>
          <input id="returnReasonText" placeholder="예) 무게 5kg 초과" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnReturnCancel">취소</button>
        <button class="btn danger" id="btnReturnConfirm">반송 처리 + 반송송장 생성</button>
      </div>
    </div>
  </div>

<script>
(()=>{
  const HUB_KIND = "terminal"; // terminal | center
  const HUB_NAME = "허브터미널";
  const LIST_KEY = "DELIVERY_TERMINALS_V1";
  const RAIL_KEY = "HUB_TERMINAL_RAIL_STATUS_V1";

  const $ = (id)=>document.getElementById(id);
  const tz = "Asia/Seoul";

  function banner(type, msg){
    const b = $("banner");
    const dot = $("bannerDot");
    $("bannerMsg").textContent = msg;
    dot.className = "badgeDot " + (type==="ok" ? "dotOk" : type==="warn" ? "dotWarn" : "dotBad");
    b.classList.add("show");
    clearTimeout(b._t);
    b._t = setTimeout(()=>b.classList.remove("show"), 4800);
  }
  $("bannerClose").addEventListener("click", ()=> $("banner").classList.remove("show"));

  function nowISO(){ return new Date().toISOString(); }
  function fmtKST(d){
    try { return new Date(d).toLocaleString("ko-KR", { timeZone: tz }); } catch { return String(d||""); }
  }
  function onlyDigits(v){ return String(v??"").replace(/[^0-9]/g,""); }
  function parseBatch(text){
    const raw = String(text||"").replace(/\r/g," ").replace(/,/g," ").replace(/\t/g," ");
    return raw.split(/\s+/).map(x=>onlyDigits(x)).filter(Boolean);
  }

  async function apiJson(path, opts={}, timeoutMs=12000){
    const u = new URL(path, location.origin);
    u.searchParams.set("_ts", String(Date.now()));
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try {
      const res = await fetch(u.toString(), {
        ...opts,
        headers: { "cache-control":"no-store", "pragma":"no-cache", ...(opts.headers||{}) },
        signal: ctrl.signal
      });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = text; }
      return { ok: res.ok, status: res.status, data };
    } finally {
      clearTimeout(t);
    }
  }

  async function kvGet(key){
    const r = await apiJson(`/api/kv/get?key=${encodeURIComponent(key)}`);
    if(!r.ok) return null;
    const d = r.data;
    if(d && typeof d === "object" && ("value" in d)) return d.value;
    return d;
  }
  async function kvSet(key, value){
    const r = await apiJson(`/api/kv/set`, {
      method:"POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify({ key, value })
    });
    return r.ok;
  }

  async function fetchAllReservations(){
    const r = await apiJson("/api/reservations");
    return (r.ok && Array.isArray(r.data)) ? r.data : [];
  }

  function candidates(rec){
    const keys = ["waybillNo","invoiceNo","invoice_no","waybill","wb","reserveNo","originalWaybillNo","returnWaybillNo"];
    const out = [];
    for(const k of keys) if(rec && rec[k]) out.push(onlyDigits(rec[k]));
    return out.filter(Boolean);
  }

  async function fetchByWaybill(wb){
    wb = onlyDigits(wb);
    if(!wb) return null;
    const r1 = await apiJson(`/api/reservations/byWaybill/${encodeURIComponent(wb)}`);
    if(r1.ok && r1.data && typeof r1.data === "object") return r1.data;
    const all = await fetchAllReservations();
    return all.find(x => candidates(x).includes(wb)) || null;
  }

  async function upsertReservation(rec){
    const r = await apiJson(`/api/reservations/upsert`, {
      method:"POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(rec)
    });
    return r.ok ? r.data : null;
  }

  function serviceLabel(type){
    const t = String(type||"").toUpperCase();
    if(t==="ECONOMY_CVS") return "반값택배";
    if(t==="INTERNATIONAL") return "국제택배";
    if(t==="RETURN") return "반품/반송";
    return "국내택배";
  }

  function ensureEvents(rec){
    if(!rec.events || !Array.isArray(rec.events)) rec.events = [];
    return rec.events;
  }

  function hubStage(rec){
    const evs = (rec.events && Array.isArray(rec.events)) ? rec.events : [];
    const rel = evs.filter(e => (e.place||"").includes(HUB_NAME));
    const last = rel.length ? rel[rel.length-1] : null;
    const msg = (last?.message||"");
    if(!last) return "NONE";
    if(msg.includes("반송접수")) return "RETURNED";
    if(msg.includes("이동될 예정")) return "MOVE_PLANNED";
    if(msg.includes("분류완료")) return "SORTED";
    if(msg.includes("간선상차")) return "OUTBOUND";
    if(msg.includes("간선하차")) return "INBOUND";
    return "OTHER";
  }

  function setStageUI(stage){
    $("stageText").textContent = stage;
    const pill = $("stagePill");
    pill.classList.remove("ok","warn","bad");
    if(stage==="INBOUND" || stage==="SORTED") pill.classList.add("ok");
    else if(stage==="OUTBOUND" || stage==="MOVE_PLANNED") pill.classList.add("warn");
    else if(stage==="RETURNED") pill.classList.add("bad");
  }

  function integrityExplain(stage){
    if(stage==="NONE") return "무결성: 아직 허브 이벤트가 없어. 먼저 입고(간선하차)를 해야 해.";
    if(stage==="INBOUND") return "무결성: 입고 완료. 분류완료 또는 출고(간선상차) 가능.";
    if(stage==="SORTED") return "무결성: 분류완료. 출고 또는 서브로 이동예정 등록 가능.";
    if(stage==="OUTBOUND") return "무결성: 출고(간선상차) 완료. 서브로 이동예정만 가능.";
    if(stage==="MOVE_PLANNED") return "무결성: 이미 이동예정을 등록했어. 중복 처리를 막았어.";
    if(stage==="RETURNED") return "무결성: 반송 처리됨. 추가 허브 처리는 막혀.";
    return "무결성: 상태 확인 필요.";
  }

  function allowButtons(stage){
    $("btnInbound").disabled = !(stage==="NONE");
    $("btnSortDone").disabled = !(stage==="INBOUND");
    $("btnOutbound").disabled = !(stage==="INBOUND" || stage==="SORTED");
    $("btnMovePlan").disabled = !(stage==="OUTBOUND" || stage==="SORTED");
    $("btnReturn").disabled = (stage==="RETURNED");
  }

  function railNum(v){
    const n = parseInt(String(v||"").trim(), 10);
    if(!Number.isFinite(n) || n<1 || n>5) return null;
    return n;
  }

  function makeEvent(place, message, actor){
    return { time: new Date().toISOString(), place, message, actor: actor || "" };
  }

  function genWaybill(prefix2){
    const prefix = String(prefix2||"").replace(/[^0-9]/g,"").slice(0,2);
    let base = Date.now().toString();
    while(base.length < 16) base += Math.floor(Math.random()*10).toString();
    base = base.slice(-16);
    return prefix + base;
  }

  function hubPlaceName(rail){
    if(rail) return `${HUB_NAME} ${rail}번 레일`;
    return HUB_NAME;
  }

  function buildMovePlanMsg(nextName){ return `${HUB_NAME} · ${nextName}로 이동될 예정입니다`; }

  function fillInfo(rec){
    $("svc").textContent = serviceLabel(rec.type);
    $("wb").textContent = onlyDigits(rec.waybillNo || rec.invoiceNo || rec.invoice_no || rec.waybill || rec.reserveNo || "");
    const sName = rec.sender?.name || rec.senderName || rec.storeName || "-";
    const sPhone = rec.sender?.phone || rec.senderPhone || rec.sender?.tel || "";
    $("sender").textContent = sPhone ? `${sName} (${sPhone})` : `${sName}`;
    const rName = rec.receiver?.name || rec.receiverName || "-";
    const rPhone = rec.receiver?.phone || rec.receiverPhone || "";
    $("receiver").textContent = rPhone ? `${rName} (${rPhone})` : `${rName}`;
  }

  function renderEvents(rec){
    const box = $("eventsList");
    box.innerHTML = "";
    const evs = (rec.events && Array.isArray(rec.events)) ? rec.events.slice(-8) : [];
    if(!evs.length){
      box.innerHTML = `<div class="help">이 운송장에는 아직 배송흐름 이벤트가 없어.</div>`;
      return;
    }
    for(const e of evs){
      const div = document.createElement("div");
      div.className = "ev";
      div.innerHTML = `
        <div class="t">${fmtKST(e.time)} · <span class="mono">${(e.place||"-")}</span></div>
        <div class="m">${(e.message||"-")}</div>
      `;
      box.appendChild(div);
    }
  }

  let current = null;

  function setCurrent(rec){
    current = rec;
    fillInfo(rec);
    renderEvents(rec);
    const st = hubStage(rec);
    setStageUI(st);
    allowButtons(st);
    $("integrityHint").textContent = integrityExplain(st);
    $("btnHubLabel").disabled = false;
  }

  function who(){ return sessionStorage.getItem(`SW_HUB_${HUB_KIND}_COURIER`) || ""; }

  function requireLogin(){
    const c = who();
    if(!c) return false;
    $("who").textContent = c;
    $("whoPill").classList.add("ok");
    return true;
  }

  function showLogin(show){
    $("loginCard").style.display = show ? "" : "none";
    $("mainCard").style.display = show ? "none" : "";
  }

  async function loadList(){
    const v = await kvGet(LIST_KEY);
    let arr = [];
    if(Array.isArray(v)) arr = v;
    else if(typeof v === "string"){ try { const p = JSON.parse(v); if(Array.isArray(p)) arr = p; } catch {} }
    else if(v && typeof v === "object" && Array.isArray(v.items)) arr = v.items;

    arr = arr.map(x => typeof x === "string" ? {name:x} : x).filter(x => x && x.name);
    const sel = $("nextSelect");
    sel.innerHTML = `<option value="">(선택 안 함)</option>`;
    for(const it of arr){
      const opt = document.createElement("option");
      opt.value = it.name;
      opt.textContent = it.name;
      sel.appendChild(opt);
    }
    $("listHelp").textContent = arr.length ? `등록됨: ${arr.length}개` : "등록된 목록이 없어. 아래에서 이름을 추가해줘.";
    return arr;
  }

  async function addToList(name){
    name = String(name||"").trim();
    if(!name) return false;
    const v = await kvGet(LIST_KEY);
    let arr = [];
    if(Array.isArray(v)) arr = v;
    else if(typeof v === "string"){ try { const p = JSON.parse(v); if(Array.isArray(p)) arr = p; } catch {} }
    else if(v && typeof v === "object" && Array.isArray(v.items)) arr = v.items;
    arr = arr.map(x => typeof x === "string" ? {name:x} : x).filter(x => x && x.name);
    if(arr.some(x => x.name === name)) return true;
    arr.push({ name, createdAt: nowISO() });
    return await kvSet(LIST_KEY, arr);
  }

  async function loadRailStatus(){
    const v = await kvGet(RAIL_KEY);
    let rails = {};
    if(v && typeof v === "object" && v.rails) rails = v.rails;
    for(let i=1;i<=5;i++) if(!rails[i]) rails[i] = "OK";
    return rails;
  }

  async function saveRailStatus(rails){ return await kvSet(RAIL_KEY, { rails, updatedAt: nowISO() }); }

  function railClass(st){ if(st==="OK") return "ok"; if(st==="FAULT") return "warn"; return "bad"; }

  async function renderRailGrid(){
    const rails = await loadRailStatus();
    const grid = $("railGrid");
    grid.innerHTML = "";
    for(let i=1;i<=5;i++){
      const st = rails[i] || "OK";
      const btn = document.createElement("div");
      btn.className = `railBtn ${railClass(st)}`;
      btn.innerHTML = `레일 ${i}<div style="margin-top:6px;font-size:11px;color:rgba(234,241,255,.78)">${st==="OK"?"정상":st==="DOWN"?"미작동":"고장"}</div>`;
      btn.addEventListener("click", async ()=>{
        const cur = rails[i] || "OK";
        const next = (cur==="OK") ? "DOWN" : (cur==="DOWN") ? "FAULT" : "OK";
        rails[i] = next;
        const ok = await saveRailStatus(rails);
        if(ok) { banner("ok", `레일 ${i} 상태 저장 완료`); renderRailGrid(); }
        else { banner("bad", "레일 상태 저장 실패(서버 확인 필요)"); }
      });
      grid.appendChild(btn);
    }
  }

  function assertRail(){
    const n = railNum($("railInput").value);
    if(!n) { banner("warn", "레일 번호(1~5)를 입력해줘."); return null; }
    return n;
  }
  function assertWaybill(){
    const wb = onlyDigits($("waybillInput").value);
    if(!wb) { banner("warn", "운송장 번호를 입력해줘."); return null; }
    return wb;
  }

  function actionAllowed(stage, action){
    if(action==="INBOUND") return stage==="NONE";
    if(action==="SORT") return stage==="INBOUND";
    if(action==="OUTBOUND") return stage==="INBOUND" || stage==="SORTED";
    if(action==="MOVE") return stage==="OUTBOUND" || stage==="SORTED";
    if(action==="RETURN") return stage!=="RETURNED";
    return false;
  }

  async function doAction(action){
    if(!requireLogin()) { banner("warn", "로그인이 필요해."); return; }
    if(!current) { banner("warn", "먼저 조회를 해줘."); return; }
    const st = hubStage(current);
    if(!actionAllowed(st, action)) { banner("bad", `무결성 검사: 현재 상태(${st})에서는 이 작업을 할 수 없어.`); return; }
    const rail = assertRail(); if(!rail) return;

    const place = hubPlaceName(rail);
    const actor = who();
    let msg = "";
    if(action==="INBOUND") msg = `${place}에서 간선하차했습니다`;
    if(action==="OUTBOUND") msg = `${place}에서 간선상차했습니다`;
    if(action==="SORT") msg = `${place}에서 분류완료되었습니다.`;

    const evs = ensureEvents(current);
    evs.push(makeEvent(place, msg, actor));
    current.updatedAt = fmtKST(nowISO());

    const saved = await upsertReservation(current);
    if(saved) { current = saved; setCurrent(current); banner("ok", "처리 완료"); }
    else { banner("bad", "저장 실패(서버/함수 확인 필요)"); }
  }

  async function doMovePlan(){
    if(!requireLogin()) { banner("warn", "로그인이 필요해."); return; }
    if(!current) { banner("warn", "먼저 조회를 해줘."); return; }
    const st = hubStage(current);
    if(!actionAllowed(st, "MOVE")) { banner("bad", `무결성 검사: 현재 상태(${st})에서는 이동예정을 등록할 수 없어.`); return; }
    const nextName = $("nextSelect").value;
    if(!nextName) { banner("warn", "이동 예정지를 선택해줘."); return; }
    const rail = assertRail(); if(!rail) return;

    const place = hubPlaceName(rail);
    const evs = ensureEvents(current);
    evs.push(makeEvent(place, buildMovePlanMsg(nextName), who()));
    current.nextPlanned = nextName;
    current.updatedAt = fmtKST(nowISO());

    const saved = await upsertReservation(current);
    if(saved) { current = saved; setCurrent(current); banner("ok", "이동예정 등록 완료"); }
    else { banner("bad", "저장 실패(서버/함수 확인 필요)"); }
  }

  function openHubLabel(rec, rail, next){
    const wb = onlyDigits(rec.waybillNo || rec.invoiceNo || rec.invoice_no || rec.waybill || rec.reserveNo || "");
    const url = new URL("hublabel.html", location.origin);
    url.searchParams.set("waybill", wb);
    url.searchParams.set("hub", HUB_KIND);
    if(rail) url.searchParams.set("rail", String(rail));
    if(next) url.searchParams.set("next", next);
    window.open(url.toString(), "_blank");
  }

  $("btnReturn").addEventListener("click", ()=>{ if(current) $("modalBack").classList.add("show"); });
  $("btnReturnCancel").addEventListener("click", ()=>$("modalBack").classList.remove("show"));

  async function doReturnCreate(){
    if(!requireLogin()) { banner("warn","로그인이 필요해."); return; }
    if(!current) { banner("warn","먼저 조회를 해줘."); return; }
    const st = hubStage(current);
    if(!actionAllowed(st, "RETURN")) { banner("bad", "이미 반송 처리된 건이야."); return; }
    const rail = assertRail(); if(!rail) return;

    const picked = $("returnReason").value;
    const typed = $("returnReasonText").value.trim();
    const reason = typed || picked || "사유미입력";

    const origWb = onlyDigits(current.waybillNo || current.invoiceNo || current.invoice_no || current.waybill || "");
    if(!origWb) { banner("bad","원 운송장 번호가 없어. 데이터 확인 필요."); return; }

    const returnWb = genWaybill("37");

    const place = hubPlaceName(rail);
    ensureEvents(current).push(makeEvent(place, `반송접수 하였습니다(사유:${reason})`, who()));
    current.returnWaybillNo = returnWb;

    const retRec = {
      type: "RETURN",
      status: "WAYBILL_ISSUED",
      waybillNo: returnWb,
      originalWaybillNo: origWb,
      createdAt: fmtKST(nowISO()),
      updatedAt: fmtKST(nowISO()),
      hub: HUB_KIND,
      sender: current.receiver || { name: "-", phone: "" },
      receiver: current.sender || { name: "-", phone: "" },
      memo: `반송 사유:${reason}`,
      events: [
        makeEvent("반송", "반송 운송장이 생성되었습니다", who()),
        makeEvent(place, `반송접수 하였습니다(사유:${reason})`, who())
      ]
    };

    $("btnReturnConfirm").disabled = true;
    const savedOrig = await upsertReservation(current);
    const savedRet = await upsertReservation(retRec);
    $("btnReturnConfirm").disabled = false;

    if(savedOrig && savedRet){
      current = savedOrig;
      setCurrent(current);
      $("modalBack").classList.remove("show");
      banner("ok", `반송 처리 완료 + 반송송장 생성(${returnWb})`);
      openHubLabel(savedRet, rail, "");
    } else {
      banner("bad", "반송 저장 실패(서버 확인 필요)");
    }
  }
  $("btnReturnConfirm").addEventListener("click", doReturnCreate);

  async function batchRun(action){
    if(!requireLogin()) { banner("warn","로그인이 필요해."); return; }
    const list = parseBatch($("batchInput").value);
    if(!list.length) { banner("warn","일괄 운송장을 입력해줘."); return; }
    const rail = railNum($("batchRail").value);
    if(!rail) { banner("warn","일괄 레일 번호(1~5)를 입력해줘."); return; }

    const results = [];
    let ok=0, fail=0;
    for(const wb of list){
      const rec = await fetchByWaybill(wb);
      if(!rec) { fail++; results.push(`❌ ${wb}: 조회 실패(없는 운송장)`); continue; }
      const st = hubStage(rec);
      const want = (action==="INBOUND")?"INBOUND":(action==="OUTBOUND")?"OUTBOUND":"SORT";
      if(!actionAllowed(st, want)) { fail++; results.push(`❌ ${wb}: 무결성 차단(현재 ${st})`); continue; }
      const place = hubPlaceName(rail);
      let msg = "";
      if(action==="INBOUND") msg = `${place}에서 간선하차했습니다`;
      if(action==="OUTBOUND") msg = `${place}에서 간선상차했습니다`;
      if(action==="SORT") msg = `${place}에서 분류완료되었습니다.`;
      ensureEvents(rec).push(makeEvent(place, msg, who()));
      const saved = await upsertReservation(rec);
      if(saved) { ok++; results.push(`✅ ${wb}: 처리 완료`); }
      else { fail++; results.push(`❌ ${wb}: 저장 실패`); }
    }
    $("batchResult").textContent = `결과: 성공 ${ok} / 실패 ${fail}\n` + results.slice(0, 60).join("\n");
    banner(ok? "ok":"bad", `일괄 처리 완료: 성공 ${ok} / 실패 ${fail}`);
  }

  async function batchLookup(){
    const list = parseBatch($("batchInput").value);
    if(!list.length) { banner("warn","일괄 운송장을 입력해줘."); return; }
    const all = await fetchAllReservations();
    const found = [];
    for(const wb of list){
      const rec = all.find(x => candidates(x).includes(wb));
      if(rec) found.push(`✅ ${wb}: ${serviceLabel(rec.type)} / 상태 ${hubStage(rec)}`);
      else found.push(`❌ ${wb}: 없음`);
    }
    $("batchResult").textContent = found.join("\n");
  }

  $("btnLogin").addEventListener("click", ()=>{
    const c = $("courierCode").value.trim();
    if(!c) { banner("warn","기사 코드를 입력해줘."); return; }
    sessionStorage.setItem(`SW_HUB_${HUB_KIND}_COURIER`, c);
    $("who").textContent = c;
    showLogin(false);
    banner("ok", "로그인 완료");
  });
  $("btnLogout").addEventListener("click", ()=>{
    sessionStorage.removeItem(`SW_HUB_${HUB_KIND}_COURIER`);
    current = null;
    showLogin(true);
    banner("ok", "로그아웃 완료");
  });

  $("waybillInput").addEventListener("input", (e)=>{ e.target.value = onlyDigits(e.target.value); });

  $("btnLookup").addEventListener("click", async ()=>{
    if(!requireLogin()) { banner("warn","로그인이 필요해."); return; }
    const wb = assertWaybill(); if(!wb) return;
    const rec = await fetchByWaybill(wb);
    if(!rec) {
      banner("bad", "등록된 운송장을 찾지 못했어.");
      current = null;
      $("btnHubLabel").disabled = true;
      $("btnReturn").disabled = true;
      return;
    }
    setCurrent(rec);
    banner("ok", "조회 완료");
  });

  $("btnInbound").addEventListener("click", ()=>doAction("INBOUND"));
  $("btnOutbound").addEventListener("click", ()=>doAction("OUTBOUND"));
  $("btnSortDone").addEventListener("click", ()=>doAction("SORT"));
  $("btnMovePlan").addEventListener("click", doMovePlan);

  $("btnHubLabel").addEventListener("click", ()=>{
    if(!current) return;
    const rail = railNum($("railInput").value) || "";
    const next = $("nextSelect").value || "";
    openHubLabel(current, rail, next);
  });

  $("btnBatchLookup").addEventListener("click", batchLookup);
  $("btnBatchInbound").addEventListener("click", ()=>batchRun("INBOUND"));
  $("btnBatchOutbound").addEventListener("click", ()=>batchRun("OUTBOUND"));
  $("btnBatchSort").addEventListener("click", ()=>batchRun("SORT"));

  $("btnListAdd").addEventListener("click", async ()=>{
    const name = $("listAddName").value.trim();
    if(!name) { banner("warn","추가할 이름을 입력해줘."); return; }
    const ok = await addToList(name);
    if(ok) { $("listAddName").value=""; await loadList(); banner("ok", "목록 추가 완료"); }
    else { banner("bad", "목록 저장 실패(서버 확인 필요)"); }
  });

  (async ()=>{
    const c = who();
    showLogin(!c);
    if(c) $("who").textContent = c;
    await loadList();
    await renderRailGrid();
    banner("ok", "준비 완료");
  })();
})();
</script>
</body>
</html>
