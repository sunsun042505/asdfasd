<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <title>작업현황 | 선우택배</title>
  <style>
    :root{
      --bg1:#071527; --bg2:#041a2c;
      --text:#eaf1ff; --muted:rgba(234,241,255,.62);
      --border:rgba(255,255,255,.10); --shadow:0 20px 60px rgba(0,0,0,.35);
      --r:18px; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Noto Sans KR", sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 70% 35%, rgba(0,180,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 35% 65%, rgba(110,231,255,.16), transparent 62%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:1180px;margin:0 auto;padding:22px 14px 36px;display:flex;flex-direction:column;gap:12px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-radius:var(--r);
         background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
         border:1px solid var(--border);box-shadow:var(--shadow);backdrop-filter: blur(10px);}
    .btn{padding:9px 11px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.20);color:var(--text);cursor:pointer;font-weight:900;font-size:12px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{border-radius:var(--r);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
          border:1px solid var(--border);box-shadow:var(--shadow);backdrop-filter: blur(10px);padding:14px;}
    .title{font-size:12px;color:rgba(234,241,255,.8);font-weight:1000;margin:0 0 10px}
    .kpi{display:grid;grid-template-columns: repeat(3, 1fr);gap:10px}
    @media(max-width:620px){.kpi{grid-template-columns:1fr}}
    .tile{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16)}
    .tile .k{font-size:11px;color:rgba(234,241,255,.65);font-weight:1000}
    .tile .v{margin-top:8px;font-size:22px;font-weight:1000}
    .railGrid{display:grid;grid-template-columns: repeat(5, 1fr);gap:8px}
    .rail{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);text-align:center;font-weight:1000;font-size:12px}
    .ok{outline:2px solid rgba(34,197,94,.35)} .warn{outline:2px solid rgba(245,158,11,.35)} .bad{outline:2px solid rgba(239,68,68,.35)}
    .legend{font-size:12px;color:rgba(234,241,255,.74);line-height:1.45;white-space:pre-wrap}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.10);font-size:12px}
    .table th{text-align:left;color:rgba(234,241,255,.72);font-weight:1000}
    .table td{font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small{font-size:11px;color:rgba(234,241,255,.62);font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div style="font-weight:1000">작업현황</div>
        <div class="small">오늘 처리량 / 허브 체류 물량 / 레일 현황</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="terminal.html">허브터미널</a>
        <a class="btn" href="center.html">허브센터</a>
        <button class="btn" id="btnRefresh">새로고침</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <p class="title">오늘 처리량 (입고 / 출고 / 반송)</p>
        <div class="kpi">
          <div class="tile"><div class="k">입고(간선하차)</div><div class="v" id="kpiInbound">-</div></div>
          <div class="tile"><div class="k">출고(간선상차)</div><div class="v" id="kpiOutbound">-</div></div>
          <div class="tile"><div class="k">반송접수/반송송장</div><div class="v" id="kpiReturn">-</div></div>
        </div>

        <div style="margin-top:14px">
          <p class="title">현재 허브에 있는 물량(최근 이벤트 기준)</p>
          <table class="table">
            <thead><tr><th>운송장</th><th>서비스</th><th>최근 위치</th><th>최근 메시지</th></tr></thead>
            <tbody id="invBody"></tbody>
          </table>
          <div class="small" id="invHint" style="margin-top:8px">-</div>
        </div>
      </div>

      <div class="card">
        <p class="title">현재 레일 작동 현황</p>
        <div class="legend">
- 초록: 정상 작동
- 빨강: 미작동
- 노랑: 고장(점검중)
(레일 상태 편집은 terminal/center 페이지에서 가능)
        </div>

        <div style="margin-top:14px">
          <p class="title">허브터미널 레일</p>
          <div class="railGrid" id="railTerminal"></div>
        </div>

        <div style="margin-top:14px">
          <p class="title">허브센터 레일</p>
          <div class="railGrid" id="railCenter"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <p class="title">작업 대기열(이동 예정)</p>
      <table class="table">
        <thead><tr><th>운송장</th><th>최근 허브</th><th>이동 예정지</th><th>메시지</th></tr></thead>
        <tbody id="planBody"></tbody>
      </table>
      <div class="small" id="planHint" style="margin-top:8px">-</div>
    </div>
  </div>

<script>
(()=>{
  const tz = "Asia/Seoul";
  const $ = (id)=>document.getElementById(id);
  function digits(v){ return String(v||"").replace(/[^0-9]/g,""); }
  function todayKey(){ return new Date().toLocaleDateString("sv-SE", { timeZone: tz }); }
  function parseTime(t){ const d = new Date(t); return isNaN(d.getTime()) ? null : d; }

  async function apiJson(path, opts={}, timeoutMs=12000){
    const u = new URL(path, location.origin);
    u.searchParams.set("_ts", String(Date.now()));
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(u.toString(), { ...opts, headers: { "cache-control":"no-store","pragma":"no-cache",...(opts.headers||{}) }, signal: ctrl.signal });
      const text = await res.text();
      let data=null; try{ data = text ? JSON.parse(text) : null; }catch{ data = text; }
      return {ok:res.ok,status:res.status,data};
    } finally { clearTimeout(t); }
  }
  async function kvGet(key){
    const r = await apiJson(`/api/kv/get?key=${encodeURIComponent(key)}`);
    if(!r.ok) return null;
    const d=r.data;
    if(d && typeof d==="object" && ("value" in d)) return d.value;
    return d;
  }
  function railClass(st){ if(st==="OK") return "ok"; if(st==="FAULT") return "warn"; return "bad"; }
  function railLabel(st){ if(st==="OK") return "정상"; if(st==="FAULT") return "고장"; return "미작동"; }
  function serviceLabel(type){
    const t = String(type||"").toUpperCase();
    if(t==="ECONOMY_CVS") return "반값택배";
    if(t==="INTERNATIONAL") return "국제택배";
    if(t==="RETURN") return "반품/반송";
    return "국내택배";
  }
  function lastEvent(rec){
    const ev = Array.isArray(rec.events) ? rec.events : [];
    return ev.length ? ev[ev.length-1] : null;
  }
  function hubInventoryFilter(rec){
    const e = lastEvent(rec);
    if(!e) return false;
    const place = String(e.place||"");
    const msg = String(e.message||"");
    const isHub = place.includes("허브터미널") || place.includes("허브센터");
    if(!isHub) return false;
    return msg.includes("간선하차") || msg.includes("분류완료");
  }
  function movePlanFilter(rec){
    const e = lastEvent(rec);
    if(!e) return false;
    const place = String(e.place||"");
    const msg = String(e.message||"");
    const isHub = place.includes("허브터미널") || place.includes("허브센터");
    return isHub && msg.includes("이동될 예정");
  }
  function countToday(evs, keyword){
    const tk = todayKey(); let c=0;
    for(const e of evs){
      const d = parseTime(e.time); if(!d) continue;
      const day = d.toLocaleDateString("sv-SE", { timeZone: tz });
      if(day!==tk) continue;
      const msg = String(e.message||"");
      if(msg.includes(keyword)) c++;
    }
    return c;
  }
  async function renderRails(){
    const t = await kvGet("HUB_TERMINAL_RAIL_STATUS_V1");
    const c = await kvGet("HUB_CENTER_RAIL_STATUS_V1");
    const tr = (t && typeof t==="object" && t.rails) ? t.rails : {};
    const cr = (c && typeof c==="object" && c.rails) ? c.rails : {};
    const termBox = $("railTerminal");
    const centBox = $("railCenter");
    termBox.innerHTML = ""; centBox.innerHTML = "";
    for(let i=1;i<=5;i++){
      const st = tr[i] || "OK";
      const div = document.createElement("div");
      div.className = `rail ${railClass(st)}`;
      div.innerHTML = `레일 ${i}<div class="small" style="margin-top:6px">${railLabel(st)}</div>`;
      termBox.appendChild(div);
    }
    for(let i=1;i<=5;i++){
      const st = cr[i] || "OK";
      const div = document.createElement("div");
      div.className = `rail ${railClass(st)}`;
      div.innerHTML = `레일 ${i}<div class="small" style="margin-top:6px">${railLabel(st)}</div>`;
      centBox.appendChild(div);
    }
  }

  async function load(){
    $("invBody").innerHTML = "";
    $("planBody").innerHTML = "";
    $("invHint").textContent = "로딩 중…";
    $("planHint").textContent = "로딩 중…";

    const r = await apiJson("/api/reservations");
    const all = (r.ok && Array.isArray(r.data)) ? r.data : [];

    let inbound=0,outbound=0,ret=0;
    for(const rec of all){
      const evs = Array.isArray(rec.events) ? rec.events : [];
      inbound += countToday(evs, "간선하차");
      outbound += countToday(evs, "간선상차");
      ret += countToday(evs, "반송접수");
      if(String(rec.type||"").toUpperCase()==="RETURN"){
        const d = parseTime(rec.createdAt) || parseTime(rec.updatedAt);
        if(d && d.toLocaleDateString("sv-SE",{timeZone:tz})===todayKey()) ret++;
      }
    }
    $("kpiInbound").textContent = inbound;
    $("kpiOutbound").textContent = outbound;
    $("kpiReturn").textContent = ret;

    const inv = all.filter(hubInventoryFilter).slice(-80).reverse();
    if(inv.length===0){
      $("invBody").innerHTML = `<tr><td colspan="4" class="small">허브 체류 물량이 없어.</td></tr>`;
    }else{
      for(const rec of inv){
        const e = lastEvent(rec);
        const wb = digits(rec.waybillNo || rec.invoiceNo || rec.invoice_no || rec.waybill || rec.reserveNo || "");
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono">${wb}</td><td>${serviceLabel(rec.type)}</td><td>${(e.place||"-")}</td><td>${(e.message||"-")}</td>`;
        $("invBody").appendChild(tr);
      }
    }
    $("invHint").textContent = `허브 체류: ${inv.length}건 (최근 이벤트가 허브 '간선하차/분류완료'인 건)`;

    const plans = all.filter(movePlanFilter).slice(-120).reverse();
    if(plans.length===0){
      $("planBody").innerHTML = `<tr><td colspan="4" class="small">이동 예정(대기열)이 없어.</td></tr>`;
    }else{
      for(const rec of plans){
        const e = lastEvent(rec);
        const wb = digits(rec.waybillNo || rec.invoiceNo || rec.invoice_no || rec.waybill || rec.reserveNo || "");
        let next = rec.nextPlanned || "";
        if(!next){
          const m = String(e.message||"");
          const mm = m.match(/·\s*(.+)로 이동될 예정/);
          if(mm) next = mm[1].trim();
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono">${wb}</td><td>${(e.place||"-")}</td><td>${next || "-"}</td><td>${(e.message||"-")}</td>`;
        $("planBody").appendChild(tr);
      }
    }
    $("planHint").textContent = `이동 예정: ${plans.length}건`;

    await renderRails();
  }

  $("btnRefresh").addEventListener("click", load);
  load();
})();
</script>
</body>
</html>
