<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>선우택배</title>
<link rel="stylesheet" href="./style.css">
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <div class="title">선우택배</div>
      <div class="sub">build 2025-12-31 15:48:00 KST · 데이터는 서버(Netlify Blobs)에 저장됨(기기 공용)</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <span class="pill" id="clock">--:--:--</span>
      <button class="btn" id="btnCustomer">고객화면</button>
      <button class="btn" onclick="location.href='./kiosk.html'">키오스크</button>
      <button class="btn" id="btnStore">점포화면</button>
      <button class="btn" id="btnCourier">기사화면</button>
      <button class="btn primary" onclick="location.href='./tracking.html'">배송조회</button>
    </div>
  </div>

  <div class="card" id="apiCard">
    <b>서버 연결</b>
    <div class="sub">여기서 OK면 저장/조회가 기기 공용으로 정상 동작</div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <button class="btn" id="ping">/api/kv/get 테스트</button>
      <span class="sub" id="pingMsg"></span>
    </div>
  </div>

  <div class="card" id="customer">
    <b>고객 예약</b>
    <div class="sub">예약번호 생성 → 키오스크에서 예약접수하면 운송장 발급</div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label class="sub">서비스</label>
        <select id="type">
          <option value="DOMESTIC">국내택배</option>
          <option value="INTERNATIONAL">국제택배</option>
          <option value="ECONOMY_CVS">반값택배</option>
          <option value="RETURN">반품택배</option>
        </select>
      </div>
      <div>
        <label class="sub">무게(kg)</label>
        <input id="w" type="number" step="0.1" min="0.1" placeholder="예: 1.2">
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div><input id="s_name" placeholder="보내는분 이름"></div>
      <div><input id="s_phone" placeholder="보내는분 전화"></div>
    </div>
    <div style="margin-top:10px;"><input id="s_addr" placeholder="보내는분 주소"></div>

    <div class="row" style="margin-top:10px;">
      <div><input id="r_name" placeholder="받는분 이름"></div>
      <div><input id="r_phone" placeholder="받는분 전화"></div>
    </div>
    <div style="margin-top:10px;"><input id="r_addr" placeholder="받는분/도착점포 주소"></div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <button class="btn primary" id="reserve">예약하기</button>
      <span class="sub" id="rmsg"></span>
    </div>
  </div>

  <div class="card" id="store" style="display:none;">
    <b>점포 화면</b>
    <div class="sub">점포코드로 로그인 → 접수된 운송장 목록 확인</div>

    <div class="row" style="margin-top:10px;">
      <div><input id="storeName" placeholder="점포명"></div>
      <div><input id="storeCode" placeholder="점포코드"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <button class="btn" id="storeRegister">점포등록</button>
      <button class="btn primary" id="storeLogin">로그인</button>
      <button class="btn" id="storeLogout" style="display:none;">로그아웃</button>
      <span class="sub" id="storeMsg"></span>
    </div>

    <div class="hr"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <b>접수/발급 목록</b>
      <button class="btn" id="storeRefresh" style="display:none;">새로고침</button>
    </div>
    <div class="list" id="storeList"></div>
  </div>

  <div class="card" id="courier" style="display:none;">
    <b>기사 화면</b>
    <div class="sub">기사코드로 로그인 → 집화(수거) 처리</div>

    <div class="row" style="margin-top:10px;">
      <div><input id="courierCode" placeholder="기사코드"></div>
      <div>
        <select id="courierRole">
          <option value="DOMESTIC">국내택배 기사</option>
          <option value="ECONOMY_CVS">반값택배 기사</option>
          <option value="INTERNATIONAL">국제택배 기사</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><input id="courierName" placeholder="기사명(등록용)"></div>
      <div><input id="courierPhone" placeholder="전화번호(등록용)"></div>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <button class="btn" id="courierRegister">기사등록</button>
      <button class="btn primary" id="courierLogin">로그인</button>
      <button class="btn" id="courierLogout" style="display:none;">로그아웃</button>
      <span class="sub" id="courierMsg"></span>
    </div>

    <div class="hr"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <b>집화 대기(점포접수됨)</b>
      <button class="btn" id="courierRefresh" style="display:none;">새로고침</button>
    </div>
    <div class="list" id="courierList"></div>
  </div>
</div>

<script type="module">
import * as c from "./client.js";

document.addEventListener("DOMContentLoaded", ()=>{
  c.startClock(c.$("clock"));

  const show=(k)=>{
    c.$("customer").style.display = (k==="customer")? "" : "none";
    c.$("store").style.display = (k==="store")? "" : "none";
    c.$("courier").style.display = (k==="courier")? "" : "none";
  };

  c.$("btnCustomer").onclick=()=>show("customer");
  c.$("btnStore").onclick=()=>show("store");
  c.$("btnCourier").onclick=()=>show("courier");

  // ping
  c.$("ping").onclick=async()=>{
    c.$("pingMsg").textContent="";
    try{
      await c.apiPost("/api/kv/set",{key:"_ping", value:{t:Date.now()}});
      await c.apiGet("/api/kv/get?key=_ping");
      c.$("pingMsg").innerHTML="<span class='ok'>OK</span>";
    }catch(e){
      c.$("pingMsg").innerHTML="<span class='err'>실패:</span> "+e.message+" (netlify.toml/Functions 확인)";
    }
  };

  // customer reserve
  c.$("reserve").onclick=async()=>{
    c.$("rmsg").textContent="";
    try{
      const rec={
        reserveNo: c.make12(),
        waybillNo: null,
        type: c.$("type").value,
        status:"RESERVED",
        sender:{name:c.$("s_name").value.trim(), phone:c.$("s_phone").value.trim(), address:c.$("s_addr").value.trim()},
        receiver:{name:c.$("r_name").value.trim(), phone:c.$("r_phone").value.trim(), address:c.$("r_addr").value.trim()},
        package:{weightKg:Number(c.$("w").value)},
        storeName:null,
        courier:null,
        events:[{time:new Date().toISOString(), place:"예약", message:"예약이 생성되었습니다"}]
      };
      if(!rec.sender.name||!rec.sender.phone||!rec.sender.address) throw new Error("보내는분 필수");
      if(!rec.receiver.name||!rec.receiver.phone||!rec.receiver.address) throw new Error("받는분/점포 주소 필수");
      if(!rec.package.weightKg||rec.package.weightKg<=0) throw new Error("무게 입력");
      await c.apiPost("/api/reservations/upsert", rec);
      c.$("rmsg").innerHTML="<span class='ok'>예약완료</span> 예약번호: <span class='mono'>"+rec.reserveNo+"</span>";
    }catch(e){
      c.$("rmsg").innerHTML="<span class='err'>실패:</span> "+e.message;
    }
  };

  // store register/login/list
  let storeSession=null;

  const renderStoreList = async ()=>{
    const list=c.$("storeList");
    list.innerHTML="";
    if(!storeSession) return;
    const all = await c.apiGet("/api/reservations");
    const mine = (all||[]).filter(x=>x.storeName===storeSession.name && x.waybillNo);
    if(mine.length===0){
      list.innerHTML = "<div class='sub'>아직 없음 (키오스크에서 접수/발급하면 여기 뜸)</div>";
      return;
    }
    mine.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||""));
    mine.forEach(rec=>{
      const last = (rec.events||[]).slice(-1)[0];
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <b>${c.typeLabel(rec.type)} · <span class="mono">${rec.waybillNo}</span></b>
        <div class="sub">보내는분: ${rec.sender?.name||"-"} / 받는분: ${rec.receiver?.name||"-"}</div>
        <div class="sub">최근: ${last? (last.place+" "+last.message) : "-"}</div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" data-track="${rec.waybillNo}">배송조회</button>
          <button class="btn primary" data-label="${rec.waybillNo}">라벨</button>
        </div>
      `;
      div.querySelector("[data-track]").onclick=()=>location.href="./tracking.html?invoice_no="+encodeURIComponent(rec.waybillNo);
      div.querySelector("[data-label]").onclick=()=>location.href="./label.html?invoice_no="+encodeURIComponent(rec.waybillNo);
      list.appendChild(div);
    });
  };

  c.$("storeRegister").onclick=async()=>{
    c.$("storeMsg").textContent="";
    try{
      await c.apiPost("/api/stores/register", {name:c.$("storeName").value.trim(), code:c.$("storeCode").value.trim()});
      c.$("storeMsg").innerHTML="<span class='ok'>등록됨</span>";
    }catch(e){
      c.$("storeMsg").innerHTML="<span class='err'>"+e.message+"</span>";
    }
  };

  c.$("storeLogin").onclick=async()=>{
    c.$("storeMsg").textContent="";
    try{
      const r=await c.apiPost("/api/stores/login", {name:c.$("storeName").value.trim(), code:c.$("storeCode").value.trim()});
      storeSession=r.store;
      c.$("storeMsg").innerHTML="<span class='ok'>로그인됨</span>";
      c.$("storeLogout").style.display="";
      c.$("storeRefresh").style.display="";
      await renderStoreList();
    }catch(e){
      c.$("storeMsg").innerHTML="<span class='err'>없는 점포</span>";
    }
  };

  c.$("storeLogout").onclick=()=>{
    storeSession=null;
    c.$("storeMsg").innerHTML="<span class='sub'>로그아웃됨</span>";
    c.$("storeLogout").style.display="none";
    c.$("storeRefresh").style.display="none";
    c.$("storeList").innerHTML="";
  };

  c.$("storeRefresh").onclick=()=>renderStoreList();

  // courier register/login/pickup
  let courierSession=null;

  const renderCourierList = async ()=>{
    const list=c.$("courierList");
    list.innerHTML="";
    if(!courierSession) return;
    const all = await c.apiGet("/api/reservations");
    const mine = (all||[]).filter(x=>x.waybillNo && x.storeName && (!x.courier || !x.courier.code) && x.type===courierSession.role);
    if(mine.length===0){
      list.innerHTML="<div class='sub'>대기 건 없음</div>";
      return;
    }
    mine.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||""));
    mine.forEach(rec=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <b>${c.typeLabel(rec.type)} · <span class="mono">${rec.waybillNo}</span></b>
        <div class="sub">접수지점: ${rec.storeName||"-"} · 받는분: ${rec.receiver?.name||"-"}</div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn primary">집화(수거)</button>
          <button class="btn">배송조회</button>
        </div>
      `;
      const btns = div.querySelectorAll("button");
      const pickupBtn=btns[0];
      const trackBtn=btns[1];
      trackBtn.onclick=()=>location.href="./tracking.html?invoice_no="+encodeURIComponent(rec.waybillNo);
      pickupBtn.onclick=async()=>{
        pickupBtn.disabled=true;
        try{
          rec.courier = {name:courierSession.name, phone:courierSession.phone, code:courierSession.code, role:courierSession.role};
          rec.status="PICKED_UP";
          rec.events = rec.events || [];
          rec.events.push({time:new Date().toISOString(), place:rec.storeName, message:"기사수거 하였습니다"});
          await c.apiPost("/api/reservations/upsert", rec);
          await renderCourierList();
        }catch(e){
          pickupBtn.disabled=false;
          alert("실패: "+e.message);
        }
      };
      list.appendChild(div);
    });
  };

  c.$("courierRegister").onclick=async()=>{
    c.$("courierMsg").textContent="";
    try{
      await c.apiPost("/api/couriers/register", {
        name:c.$("courierName").value.trim(),
        phone:c.$("courierPhone").value.trim(),
        code:c.$("courierCode").value.trim(),
        role:c.$("courierRole").value
      });
      c.$("courierMsg").innerHTML="<span class='ok'>등록됨</span>";
    }catch(e){
      c.$("courierMsg").innerHTML="<span class='err'>"+e.message+"</span>";
    }
  };

  c.$("courierLogin").onclick=async()=>{
    c.$("courierMsg").textContent="";
    try{
      const r=await c.apiPost("/api/couriers/login", {code:c.$("courierCode").value.trim()});
      courierSession=r.courier;
      const want=c.$("courierRole").value;
      if(courierSession.role!==want){
        c.$("courierMsg").innerHTML="<span class='err'>"+c.typeLabel(courierSession.role)+" 입니다</span>";
        c.$("courierRole").value=courierSession.role;
      }else{
        c.$("courierMsg").innerHTML="<span class='ok'>로그인됨</span>";
      }
      c.$("courierLogout").style.display="";
      c.$("courierRefresh").style.display="";
      await renderCourierList();
    }catch(e){
      c.$("courierMsg").innerHTML="<span class='err'>없는 기사입니다</span>";
    }
  };

  c.$("courierLogout").onclick=()=>{
    courierSession=null;
    c.$("courierMsg").innerHTML="<span class='sub'>로그아웃됨</span>";
    c.$("courierLogout").style.display="none";
    c.$("courierRefresh").style.display="none";
    c.$("courierList").innerHTML="";
  };
  c.$("courierRefresh").onclick=()=>renderCourierList();
});
</script>
</body></html>
